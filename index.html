
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HỆ THỐNG QUẢN LÝ QUÂN NHÂN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #14452F;
            /* Deep Military Green */
            --primary-hover: #0e3322;
            --accent-color: #d4af37;
            /* Metallic Gold */
            --bg-color: #f4f6f8;
            --text-dark: #2c3e50;
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            height: 100vh;
            overflow-x: hidden;
            background-color: var(--bg-color);
            font-family: 'Roboto', sans-serif;
            color: var(--text-dark);
        }

        /* --- UTILITIES --- */
        .text-military {
            color: var(--primary-color) !important;
        }

        .text-gold {
            color: var(--accent-color) !important;
        }

        .bg-military {
            background-color: var(--primary-color) !important;
            color: white;
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 8px 16px;
            transition: all 0.3s ease;
        }

        .btn-military {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .btn-military:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(20, 69, 47, 0.3);
            color: white;
        }

        .btn-gold {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
        }

        .btn-gold:hover {
            background-color: #c49f2b;
            color: #fff;
        }

        .form-control:focus,
        .form-select:focus,
        .form-check-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(20, 69, 47, 0.15);
        }

        /* --- MODERN LOGIN SCREEN --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2e1f 0%, #14452F 100%);
            z-index: 9000;
            /* High but below Modal */
            display: flex;
            align-items: center;
            justify-content: center;
            background-image:
                radial-gradient(at 10% 10%, rgba(212, 175, 55, 0.1) 0px, transparent 50%),
                radial-gradient(at 90% 90%, rgba(20, 69, 47, 0.5) 0px, transparent 50%);
        }

        /* FIX: Ensure Modal sits on top of the Login Screen */
        .modal {
            z-index: 10050 !important;
        }

        .modal-backdrop {
            z-index: 10040 !important;
        }

        .login-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            width: 900px;
            height: 550px;
            display: flex;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-left {
            flex: 1;
            background: url('https://images.unsplash.com/photo-1579912437766-79b846d0a775?q=80&w=1000&auto=format&fit=crop') center/cover no-repeat;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 40px;
            color: white;
        }

        .login-left::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(20, 69, 47, 0.9), rgba(20, 69, 47, 0.3));
        }

        .login-left-content {
            position: relative;
            z-index: 1;
        }

        .app-title {
            font-size: 2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            border-bottom: 3px solid var(--accent-color);
            display: inline-block;
            padding-bottom: 5px;
        }

        .login-right {
            flex: 1;
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .login-btn-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-option-btn {
            width: 100%;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 30px;
            font-size: 1.1rem;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .login-option-btn i {
            font-size: 1.8rem;
            margin-right: 20px;
            width: 40px;
            text-align: center;
        }

        .btn-commander {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-commander:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 8px 20px rgba(20, 69, 47, 0.25);
        }

        .btn-soldier {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-soldier:hover {
            background-color: #f0f7f4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        /* --- SIDEBAR & LAYOUT --- */
        .sidebar {
            height: 100vh;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .main-content {
            margin-left: 16.66667%;
            /* Offset for col-md-2 sidebar */
            min-height: 100vh;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            padding: 15px 25px;
            border-left: 4px solid transparent;
            font-weight: 500;
            text-decoration: none;
            display: block;
        }

        .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-link.active {
            color: white;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            border-left-color: var(--accent-color);
        }

        .top-bar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 900;
        }

        .card {
            border: none;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* --- KIOSK MODE --- */
        .kiosk-container {
            min-height: 100vh;
            background-color: #f0f2f5;
            padding-bottom: 50px;
        }

        .kiosk-header-bar {
            background: var(--primary-color);
            color: white;
            padding: 30px 0 80px 0;
            text-align: center;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 50% 100%, 0 85%);
        }

        .kiosk-card {
            margin-top: -50px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* --- NOTIFICATIONS --- */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10100;
            /* Above everything */
            min-width: 350px;
        }

        .toast-modern {
            background: white;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
        }

        /* --- IMAGE PREVIEW --- */
        .image-upload-container {
            width: 140px;
            height: 180px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            background-color: #f8f9fa;
            cursor: pointer;
            margin: 0 auto;
        }

        .image-upload-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-upload-container:hover {
            border-color: var(--primary-color);
        }

        /* TABS CUSTOMIZATION */
        .nav-tabs {
            border-bottom: 2px solid #eee;
        }

        .nav-tabs .nav-link {
            color: #555;
            font-weight: 500;
            border: none;
            padding: 12px 20px;
            margin-bottom: 0;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background: rgba(0, 0, 0, 0.02);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: bold;
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .sub-label {
            font-size: 0.85rem;
            color: #777;
            margin-top: -5px;
            margin-bottom: 8px;
            display: block;
        }

        .sensitive-section {
            border-left: 3px solid #dc3545;
        }

        /* USER GUIDE STYLING */
        .guide-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .guide-step-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .guide-step-content h6 {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .caps-warning {
            display: none;
            font-size: 0.75rem;
            color: #dc3545;
            margin-top: 4px;
        }
    </style>
</head>

<body>

    <div id="notification-container"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-card">
            <div class="login-left">
                <div class="login-left-content">
                    <div class="app-title">QLQN SYSTEM</div>
                    <h2 class="mb-3">QUẢN LÝ HỒ SƠ<br>CHIẾI SĨ</h2>
                    <p class="opacity-75">Hệ thống quản lý thông tin quân nhân chuyên nghiệp, bảo mật và hiệu quả.</p>
                    <small class="text-gold mt-4 d-block"><i class="bi bi-shield-check me-2"></i>Phiên bản 2.3.0</small>
                </div>
            </div>
            <div class="login-right">
                <h3 class="text-military fw-bold mb-1">CHỌN CHẾ ĐỘ</h3>
                <p class="text-muted mb-5">Vui lòng chọn môi trường làm việc</p>

                <div class="login-btn-group">
                    <button id="btn-commander" class="login-option-btn btn-commander shadow-sm">
                        <i class="bi bi-person-badge-fill"></i>
                        <div class="text-start">
                            <div class="fw-bold">CHỈ HUY / QUẢN TRỊ</div>
                            <small style="font-size: 0.8rem; opacity: 0.9">Truy cập Dashboard, duyệt hồ sơ</small>
                        </div>
                    </button>

                    <button id="btn-soldier" class="login-option-btn btn-soldier">
                        <i class="bi bi-pencil-square"></i>
                        <div class="text-start">
                            <div class="fw-bold">CHIẾN SĨ NHẬP LIỆU</div>
                            <small class="text-muted" style="font-size: 0.8rem;">Chế độ Kiosk nhập thông tin</small>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL (ADMIN) -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-military text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="bi bi-shield-lock me-2"></i>ĐĂNG NHẬP HỆ THỐNG</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="adminLoginForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tên đăng nhập</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                                <input type="text" class="form-control" id="loginUsername"
                                    placeholder="Nhập tên đăng nhập" autocomplete="off">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">Mật khẩu</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-key"></i></span>
                                <input type="password" class="form-control password-input" id="loginPassword"
                                    placeholder="Nhập mật khẩu">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="caps-warning"><i class="bi bi-capslock-fill"></i> Đang bật Caps Lock!</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-military py-2">
                                ĐĂNG NHẬP <i class="bi bi-arrow-right-short"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT CUSTOM FIELD MODAL -->
    <div class="modal fade" id="customFieldModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-military text-white">
                    <h5 class="modal-title fw-bold" id="customFieldModalTitle">Thêm Trường Dữ Liệu Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="customFieldForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tên Hiển Thị (display_name) <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cfDisplayName" required
                                placeholder="VD: Phụ cấp thâm niên">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Khóa Dữ Liệu (field_key) <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control font-monospace" id="cfKey" required
                                placeholder="VD: phu_cap_tham_nien">
                            <div class="form-text text-muted">Dùng để lưu trong CSDL. Không chứa dấu cách, chỉ dùng chữ
                                không dấu và gạch dưới.</div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Kiểu Dữ Liệu (data_type)</label>
                                <select class="form-select" id="cfType">
                                    <option value="TEXT">Văn bản ngắn (Text)</option>
                                    <option value="INTEGER">Số (Integer)</option>
                                    <option value="DATE">Ngày tháng (Date)</option>
                                    <option value="BOOLEAN">Có/Không (Yes/No)</option>
                                    <option value="TEXTAREA">Văn bản dài (Textarea)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Đơn Vị Áp Dụng (unit_id)</label>
                                <select class="form-select" id="cfUnit">
                                    <option value="">-- Toàn Hệ Thống --</option>
                                    <!-- Populated via JS -->
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="cfRequired">
                                <label class="form-check-label" for="cfRequired">Bắt buộc nhập (is_required)</label>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-military px-4">Lưu Trường Mới</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN LAYOUT -->
    <div id="admin-layout" class="container-fluid d-none">
        <div class="row">
            <div class="col-md-2 sidebar p-0">
                <div class="sidebar-header d-flex align-items-center gap-3">
                    <div class="bg-white text-military rounded-circle d-flex align-items-center justify-content-center"
                        style="width: 40px; height: 40px;">
                        <i class="bi bi-stars"></i>
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold">QLQN SYSTEM</h6>
                        <small class="text-gold" style="font-size: 0.7rem;">ADMINISTRATOR</small>
                    </div>
                </div>
                <div class="mt-4 d-flex flex-column h-100 pb-4">
                    <a class="nav-link active" href="#" id="nav-dashboard" onclick="switchAdminView('dashboard')" title="Danh Sách Quân Nhân (Alt + 1)">
                        <i class="bi bi-grid-fill me-3"></i>Danh Sách
                    </a>
                    <a class="nav-link" href="#" id="nav-units" onclick="switchAdminView('units')" title="Quản Lý Tổ Chức (Alt + 2)">
                        <i class="bi bi-diagram-3-fill me-3"></i>Tổ Chức
                    </a>
                    <a class="nav-link" href="#" id="nav-add-admin" onclick="switchAdminView('add')" title="Nhập Liệu Quân Nhân (Alt + 3)">
                        <i class="bi bi-person-plus-fill me-3"></i>Nhập Liệu
                    </a>
                    <a class="nav-link" href="#" id="nav-settings" onclick="switchAdminView('settings')" title="Cài Đặt Hệ Thống (Alt + 4)">
                        <i class="bi bi-gear-fill me-3"></i>Cài Đặt
                    </a>
                </div>
            </div>

            <div class="col-md-10 main-content">
                <div class="top-bar">
                    <h4 id="page-title" class="m-0 text-military fw-bold">DANH SÁCH QUÂN NHÂN</h4>
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-end d-none d-md-block">
                            <div class="fw-bold text-dark">Chỉ huy trưởng</div>
                            <small class="text-muted">Đang trực tuyến</small>
                        </div>
                        <div class="bg-military text-white rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 40px; height: 40px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div class="vr mx-2"></div>
                        <button class="btn btn-outline-danger border-0" onclick="logout()" title="Đăng xuất (Esc)">
                            <i class="bi bi-box-arrow-right fs-5"></i>
                        </button>
                    </div>
                </div>

                <div class="p-4">
                    <!-- Dashboard View -->
                    <div id="view-dashboard">
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-body">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-3">
                                        <label class="small text-muted mb-1">Lọc theo đơn vị</label>
                                        <select id="unitFilter" class="form-select border-light bg-light"
                                            onchange="loadSoldiers()">
                                            <option value="all">Tất cả đơn vị</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small text-muted mb-1">Bộ lọc chi tiết</label>
                                        <select id="statusFilter" class="form-select border-light bg-light"
                                            onchange="loadSoldiers()">
                                            <option value="all">Tất cả trạng thái</option>
                                            <optgroup label="Tổ chức Chính trị">
                                                <option value="dang_vien">Đảng viên</option>
                                                <option value="doan_vien">Đoàn viên</option>
                                            </optgroup>
                                            <optgroup label="Học vấn">
                                                <option value="da_tn">Đã tốt nghiệp</option>
                                                <option value="chua_tn">Chưa tốt nghiệp</option>
                                            </optgroup>
                                            <optgroup label="An ninh - Kỷ luật">
                                                <option value="vay_no">Có vay nợ</option>
                                                <option value="ma_tuy">Tiền sự ma túy</option>
                                                <option value="danh_bac">Tham gia đánh bạc</option>
                                                <option value="canh_bao">Cần quan tâm đặc biệt (Tổng hợp)</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small text-muted mb-1">Tìm kiếm (Tên/CCCD) (Alt + S)</label>
                                        <input type="text" id="globalSearchInput"
                                            class="form-control border-light bg-light"
                                            placeholder="Nhập tên hoặc CCCD... (Alt + S)"
                                            onkeydown="if(event.key === 'Enter') loadSoldiers()">
                                    </div>
                                    <div class="col-md-3 text-end d-flex align-items-end justify-content-end">
                                        <button class="btn btn-light text-military border me-2"
                                            onclick="loadSoldiers()" title="Làm mới danh sách (Alt + R)">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Làm mới
                                        </button>
                                        <button class="btn btn-military" onclick="switchAdminView('add')" title="Thêm hồ sơ mới (Alt + N)">
                                            <i class="bi bi-plus-lg me-1"></i> Thêm mới
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4">ID</th>
                                            <th>Họ Tên</th>
                                            <th>Cấp Bậc</th>
                                            <th>Đơn Vị</th>
                                            <th>Cảnh Báo</th>
                                            <th class="text-end pe-4">Thao Tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="soldierTableBody">
                                        <!-- Data Loaded Here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Units View -->
                    <div id="view-units" class="d-none">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="card shadow-sm h-100 border-0">
                                    <div class="card-header bg-white fw-bold text-military border-bottom py-3">
                                        <i class="bi bi-diagram-2 me-2"></i>Cây Đơn Vị
                                    </div>
                                    <div class="card-body unit-tree" id="unitTreeContainer">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="d-flex justify-content-end mb-3">
                                    <button class="btn btn-gold" onclick="exportUnitsToCSV()">
                                        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Xuất Danh Sách Đơn Vị (CSV)
                                    </button>
                                </div>
                                <div class="card shadow-sm border-0">
                                    <div class="card-header bg-white fw-bold text-military border-bottom py-3">
                                        Thêm Đơn Vị Mới
                                    </div>
                                    <div class="card-body p-4">
                                        <form id="unitForm">
                                            <div class="mb-3">
                                                <label class="form-label">Tên Đơn Vị (VD: Trung đội 1)</label>
                                                <input type="text" class="form-control" id="newUnitName" required
                                                    placeholder="Nhập tên đơn vị...">
                                            </div>
                                            <div class="mb-4">
                                                <label class="form-label">Trực thuộc (Cấp trên)</label>
                                                <select class="form-select" id="newUnitParent">
                                                    <option value="">-- Không (Cấp cao nhất) --</option>
                                                </select>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Chọn đơn
                                                    vị bên trái để xóa</small>
                                                <button type="submit" class="btn btn-military px-4">Lưu Đơn Vị</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add New View (Placeholder for injection) -->
                    <div id="view-add-container" class="d-none"></div>

                    <!-- Settings View -->
                    <div id="view-settings" class="d-none">
    <div class="row g-4">
        <div class="col-md-5">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white fw-bold text-military border-bottom py-3">
                    <i class="bi bi-shield-lock me-2"></i>ĐỔI MẬT KHẨU QUẢN TRỊ
                </div>
                <div class="card-body p-4">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu hiện tại</label>
                            <div class="input-group">
                                <input type="password" class="form-control password-input" id="currentPassword" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="caps-warning"><i class="bi bi-capslock-fill"></i> Đang bật Caps Lock!</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu mới</label>
                            <div class="input-group">
                                <input type="password" class="form-control password-input" id="newPassword" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="caps-warning"><i class="bi bi-capslock-fill"></i> Đang bật Caps Lock!</div>
                            <small class="text-muted" style="font-size: 0.75rem;">Yêu cầu: 8+ ký tự, 1 CHỮ HOA, 1 ký tự đặc biệt.</small>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Xác nhận mật khẩu</label>
                            <div class="input-group">
                                <input type="password" class="form-control password-input" id="confirmNewPassword" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="caps-warning"><i class="bi bi-capslock-fill"></i> Đang bật Caps Lock!</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-military">Cập nhật bảo mật</button>
                        </div>
                    </form>
                </div>
            </div>
           
            <div class="card shadow-sm border-0 mb-4 border-start border-4 border-warning">
                <div class="card-header bg-white fw-bold text-military border-bottom py-3">
                    <i class="bi bi-database-fill-gear me-2 text-warning"></i>QUẢN TRỊ DỮ LIỆU & BẢO TRÌ
                </div>
                <div class="card-body p-4">
                    <p class="small text-muted mb-4">Quản lý tệp tin cơ sở dữ liệu. Vui lòng sao lưu định kỳ để tránh mất dữ liệu.</p>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary mt-3" onclick="updateSoftware()">
                            <i class="bi bi-cloud-download me-2"></i> Cập nhật phiên bản mới
                        </button>
                        <button class="btn btn-light border text-start py-2" onclick="backupDatabase()">
                            <i class="bi bi-cloud-arrow-up-fill me-2 text-primary"></i> <b>Sao lưu toàn bộ</b>
                            <small class="d-block text-muted">Xuất tệp tin .db để lưu trữ an toàn</small>
                        </button>
                        
                        <button class="btn btn-light border text-start py-2" onclick="restoreDatabase()">
                            <i class="bi bi-cloud-arrow-down-fill me-2 text-success"></i> <b>Khôi phục từ tệp</b>
                            <small class="d-block text-muted">Ghi đè dữ liệu từ bản sao lưu cũ</small>
                        </button>
                        
                        <hr class="my-2">
                        
                        <button class="btn btn-outline-danger text-start border-dashed py-2" onclick="clearAllData()">
                            <i class="bi bi-trash3-fill me-2"></i> <b>Xóa toàn bộ dữ liệu</b>
                            <small class="d-block opacity-75">Xóa sạch Database và khởi động lại</small>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body p-4 text-center">
                    <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-patch-check-fill text-military fs-2"></i>
                    </div>
                    <h5 class="fw-bold text-military mb-1">DHsystem 2026</h5>
                    <p class="text-muted small mb-0">Phần mềm Quản lý Hồ sơ Quân nhân v3.6.0</p>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm border-0 h-100">
    <div class="card-header bg-white fw-bold text-military border-bottom py-3 d-flex justify-content-between align-items-center">
        <span><i class="bi bi-book-half me-2"></i>HƯỚNG DẪN VẬN HÀNH HỆ THỐNG</span>
        <span class="badge bg-military">Phiên bản 2026</span>
    </div>
    <div class="card-body p-4 overflow-auto" style="max-height: 700px;">
        
        <div class="guide-step">
            <div class="guide-step-icon">1</div>
            <div class="guide-step-content">
                <h6>Thiết lập Sơ đồ tổ chức (Alt + 2)</h6>
                <p class="small text-muted">Truy cập menu <strong>"Tổ chức"</strong>. Bạn cần tạo các đơn vị từ cấp cao nhất (VD: Tiểu đoàn) rồi mới tạo các đơn vị trực thuộc (VD: Đại đội, Trung đội). Click trực tiếp vào tên đơn vị trong cây thư mục để thực hiện lệnh xóa.</p>
            </div>
        </div>

        <div class="guide-step">
            <div class="guide-step-icon">2</div>
            <div class="guide-step-content">
                <h6>Cấu hình Trường tùy chỉnh (Dynamic Fields)</h6>
                <p class="small text-muted">Trong phần <strong>"Nhập liệu" -> "8. Thông tin bổ sung"</strong>, Admin có thể tạo thêm các ô nhập liệu đặc thù. Ví dụ: "Số súng", "Cỡ quân trang". Các trường này sẽ tự động xuất hiện khi bạn chọn đúng đơn vị đã cấu hình.</p>
            </div>
        </div>

        <div class="guide-step">
            <div class="guide-step-icon">3</div>
            <div class="guide-step-content">
                <h6>Quy trình Nhập liệu (Alt + 3 hoặc Alt + N)</h6>
                <p class="small text-muted">Hệ thống hỗ trợ 02 chế độ:
                    <br>• <b>Chế độ Chỉ huy:</b> Admin trực tiếp nhập và duyệt hồ sơ.
                    <br>• <b>Chế độ Kiosk:</b> Cho phép chiến sĩ tự nhập thông tin tại máy công cộng. Sau khi lưu, hồ sơ sẽ tự động chuyển về danh sách quản lý của Admin.</p>
            </div>
        </div>

        <div class="guide-step">
            <div class="guide-step-icon">4</div>
            <div class="guide-step-content">
                <h6>Tìm kiếm và Lọc (Alt + S)</h6>
                <p class="small text-muted">Sử dụng thanh công cụ tại <strong>"Danh sách"</strong> để lọc quân nhân theo đơn vị hoặc trạng thái đặc biệt (Đảng viên, Đoàn viên, quân nhân nợ nần, vi phạm kỷ luật...). Nhấn <b>Enter</b> để tìm kiếm nhanh theo Tên hoặc CCCD.</p>
            </div>
        </div>

        <div class="guide-step">
            <div class="guide-step-icon">5</div>
            <div class="guide-step-content">
                <h6>Xuất bản Hồ sơ (PDF/CSV)</h6>
                <p class="small text-muted">Tại bảng danh sách, nhấn biểu tượng <i class="bi bi-file-earmark-pdf"></i> để xuất Lý lịch trích ngang PDF chuẩn. Hệ thống tự động tổng hợp toàn bộ thông tin từ lịch sử công tác đến quan hệ gia đình vào tệp tin.</p>
            </div>
        </div>

        <div class="guide-step">
            <div class="guide-step-icon">6</div>
            <div class="guide-step-content">
                <h6>Sao lưu và Bảo mật</h6>
                <p class="small text-muted">Sử dụng công cụ <b>"Sao lưu toàn bộ"</b> định kỳ hàng tuần. Trong trường hợp cài lại máy hoặc hỏng dữ liệu, hãy dùng chức năng <b>"Khôi phục từ tệp"</b> để lấy lại toàn bộ hồ sơ.</p>
            </div>
        </div>

        <div class="mt-4 p-3 bg-light rounded border">
            <h6 class="fw-bold mb-2 small"><i class="bi bi-keyboard me-2"></i>HỆ THỐNG PHÍM TẮT NHANH</h6>
            <div class="row g-2">
                <div class="col-6 small"><code>Alt + 1</code>: Danh sách</div>
                <div class="col-6 small"><code>Alt + 2</code>: Tổ chức</div>
                <div class="col-6 small"><code>Alt + 3</code>: Nhập liệu</div>
                <div class="col-6 small"><code>Alt + S</code>: Tìm kiếm</div>
                <div class="col-6 small"><code>Alt + R</code>: Làm mới</div>
                <div class="col-6 small"><code>Esc</code>: Đăng xuất/Quay lại</div>
            </div>
        </div>

        <div class="alert alert-danger border-0 small mt-4">
            <i class="bi bi-exclamation-octagon-fill me-2"></i><strong>CẢNH BÁO:</strong> Mật khẩu quản trị mặc định là <code>123456</code>. Hãy thực hiện đổi mật khẩu ngay trong lần đầu sử dụng để đảm bảo an toàn thông tin.
        </div>
    </div>
</div>

    <!-- KIOSK LAYOUT -->
    <div id="kiosk-layout" class="d-none kiosk-container">
        <div class="kiosk-header-bar">
            <h1 class="fw-bold mb-2">CẬP NHẬT LÝ LỊCH QUÂN NHÂN</h1>
            <p class="opacity-75">Vui lòng điền đầy đủ, chính xác các thông tin dưới đây</p>
            <button class="btn btn-outline-light btn-sm mt-2" onclick="logout()" title="Quay lại màn hình đăng nhập (Esc)">
                <i class="bi bi-arrow-left"></i> Quay lại Đăng nhập (Esc)
            </button>
        </div>

        <div class="container pb-5">
            <div class="row justify-content-center">
                <div class="col-lg-11">
                    <div id="kiosk-form-card" class="card kiosk-card border-0">
                        <div class="card-body p-5">
                            <!-- Form Injected Here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TEMPLATE: SOLDIER FORM REDESIGNED -->
    <template id="form-template">
        <form id="soldierForm" class="needs-validation" novalidate>
            <!-- HEAD TABS -->
            <ul class="nav nav-tabs mb-4" id="formTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-info"
                        type="button">1. Thông Tin Chung</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-bio"
                        type="button">2. Tiểu Sử & MXH</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-family"
                        type="button">3. Gia Đình & Hôn Nhân</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-foreign"
                        type="button">4. Yếu Tố Nước Ngoài</button></li>
                <li class="nav-item"><button class="nav-link text-danger fw-bold" data-bs-toggle="tab"
                        data-bs-target="#tab-history" type="button">5. Lịch Sử & Tệ Nạn</button></li>
                <li class="nav-item"><button class="nav-link text-danger fw-bold" data-bs-toggle="tab"
                        data-bs-target="#tab-finance" type="button">6. Tài Chính & Sức Khỏe</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-aspirations"
                        type="button">7. Cam Kết & Nguyện Vọng</button></li>
                <li class="nav-item"><button class="nav-link text-primary" data-bs-toggle="tab"
                        data-bs-target="#tab-custom" type="button">8. Thông tin bổ sung</button></li>
            </ul>

            <div class="tab-content" id="formTabsContent">

                <!-- TAB 1: THÔNG TIN CHUNG -->
                <div class="tab-pane fade show active" id="tab-info" role="tabpanel">
                    <div class="section-title"><i class="bi bi-person-lines-fill me-2"></i>Thông tin cơ bản</div>
                    <div class="row g-4">
                        <div class="col-md-3 text-center">
                            <div class="image-upload-container mb-2"
                                onclick="document.getElementById('imageInput').click()">
                                <img id="imagePreview" src="https://via.placeholder.com/140x180?text=ẢNH+3x4"
                                    alt="Ảnh thẻ">
                            </div>
                            <input type="file" id="imageInput" class="d-none" accept="image/*">
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2"
                                onclick="document.getElementById('imageInput').click()">
                                <i class="bi bi-camera"></i> Chọn ảnh
                            </button>
                        </div>
                        <div class="col-md-9">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Họ và tên khai sinh <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control text-uppercase fw-bold" name="ho_ten"
                                        required placeholder="NGUYỄN VĂN A">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tên khác (nếu có)</label>
                                    <input type="text" class="form-control" name="ten_khac">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Ngày sinh <span
                                            class="text-danger">*</span></label>
                                    <input type="date" class="form-control" name="ngay_sinh" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">CCCD/CMND <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="cccd" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">SĐT Cá nhân</label>
                                    <input type="text" class="form-control" name="sdt_rieng"
                                        placeholder="Số thường dùng">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">HKTT (Số nhà, đường, ấp, khu phố, xã/phường...)</label>
                                    <textarea class="form-control" name="ho_khau_thuong_tru" rows="2"
                                        placeholder="Ghi cụ thể địa chỉ thường trú..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Nơi sinh (Xã, Huyện, Tỉnh)</label>
                                    <input type="text" class="form-control" name="noi_sinh">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Dân tộc</label>
                                    <input type="text" class="form-control" name="dan_toc" value="Kinh">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Tôn giáo</label>
                                    <input type="text" class="form-control" name="ton_giao" value="Không">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Trình độ học vấn</label>
                                    <input type="text" class="form-control" name="trinh_do_van_hoa" placeholder="12/12">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Đã tốt nghiệp chưa?</label>
                                    <div class="d-flex gap-3 pt-1">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="da_tot_nghiep" value="1">
                                            <label class="form-check-label">Đã TN</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="da_tot_nghiep" value="0"
                                                checked>
                                            <label class="form-check-label">Chưa TN</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Năng khiếu/Sở trường</label>
                                    <textarea class="form-control" name="nang_khieu_so_truong" rows="1"
                                        placeholder="Vẽ, đàn, hát, sửa chữa..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title mt-4"><i class="bi bi-briefcase-fill me-2"></i>Đơn vị & Tổ chức</div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Đơn vị <span class="text-danger">*</span></label>
                            <select class="form-select" name="don_vi_id" id="formUnitSelect" required></select>
                            <input type="hidden" name="don_vi" id="formUnitName">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Cấp bậc</label>
                            <select class="form-select" name="cap_bac">
                                <option value="Binh nhì">Binh nhì</option>
                                <option value="Binh nhất">Binh nhất</option>
                                <option value="Hạ sĩ">Hạ sĩ</option>
                                <option value="Trung sĩ">Trung sĩ</option>
                                <option value="Thượng sĩ">Thượng sĩ</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Chức vụ</label>
                            <input type="text" class="form-control" name="chuc_vu">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ngày nhập ngũ</label>
                            <input type="date" class="form-control" name="nhap_ngu_ngay">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ngày vào Đoàn</label>
                            <input type="date" class="form-control" name="ngay_vao_doan">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ngày vào Đảng</label>
                            <input type="date" class="form-control" name="vao_dang_ngay">
                        </div>
                    </div>
                </div>

                <!-- TAB 2: TIỂU SỬ & MXH -->
                <div class="tab-pane fade" id="tab-bio" role="tabpanel">
                    <div class="section-title"><i class="bi bi-clock-history me-2"></i>Quá trình từ 10 tuổi đến nhập ngũ
                        (học gì, làm gì, ở đâu)</div>
                    <div class="table-responsive border rounded bg-white mb-4">
                        <table class="table table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="20%">Thời gian</th>
                                    <th width="40%">Làm gì? Chức vụ?</th>
                                    <th width="35%">Ở đâu?</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="bioTableBody"></tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary dashed-border mb-4"
                        onclick="window.addBioRow()"><i class="bi bi-plus-lg"></i> Thêm mốc thời gian</button>

                    <div class="section-title"><i class="bi bi-phone me-2"></i>Mạng Xã Hội</div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-header fw-bold text-primary"><i
                                        class="bi bi-facebook me-2"></i>Facebook</div>
                                <div class="card-body">
                                    <div id="container-facebook"></div>
                                    <button type="button" class="btn btn-sm w-100 btn-outline-primary"
                                        onclick="window.addSocialRow('facebook')">Thêm tài khoản</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-header fw-bold text-info"><i class="bi bi-chat-fill me-2"></i>Zalo
                                </div>
                                <div class="card-body">
                                    <div id="container-zalo"></div>
                                    <button type="button" class="btn btn-sm w-100 btn-outline-info"
                                        onclick="window.addSocialRow('zalo')">Thêm tài khoản</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-header fw-bold text-dark"><i class="bi bi-tiktok me-2"></i>Tiktok</div>
                                <div class="card-body">
                                    <div id="container-tiktok"></div>
                                    <button type="button" class="btn btn-sm w-100 btn-outline-dark"
                                        onclick="window.addSocialRow('tiktok')">Thêm tài khoản</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: GIA ĐÌNH -->
                <div class="tab-pane fade" id="tab-family" role="tabpanel">
                    <div class="section-title"><i class="bi bi-house-heart-fill me-2"></i>Hoàn cảnh sống trước nhập ngũ
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Trước khi nhập ngũ sống chung với ai?</label>
                            <div class="d-flex gap-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="song_chung_voi_option"
                                        value="Bố">
                                    <label class="form-check-label">Bố</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="song_chung_voi_option"
                                        value="Mẹ">
                                    <label class="form-check-label">Mẹ</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkKhac"
                                        onchange="toggleSection('divNguoiNuoiDuong', this.checked)">
                                    <label class="form-check-label">Người nuôi dưỡng khác</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 d-none" id="divNguoiNuoiDuong">
                            <div class="card card-body bg-light">
                                <label class="small text-muted mb-2">Thông tin người nuôi dưỡng khác:</label>
                                <div class="row g-2">
                                    <div class="col-md-4"><input type="text" class="form-control" id="nnd_ten"
                                            placeholder="Họ tên (Sống chung với ai khác?)"></div>
                                    <div class="col-md-4"><input type="text" class="form-control" id="nnd_nghe"
                                            placeholder="Nghề nghiệp"></div>
                                    <div class="col-md-4"><input type="text" class="form-control" id="nnd_diachi"
                                            placeholder="Địa chỉ"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Lý do không sống chung với bố, mẹ (nếu có)</label>
                            <textarea class="form-control" name="ly_do_khong_song_cung_bo_me" rows="3"
                                placeholder="Ghi rõ lý do..."></textarea>
                        </div>
                    </div>

                    <div class="section-title mt-4"><i class="bi bi-info-square-fill me-2"></i>Thông tin chung về gia
                        đình</div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Nghề nghiệp chính của gia đình</label>
                            <input type="text" class="form-control" id="gd_nghe_nghiep_chinh">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mức sống của gia đình</label>
                            <select class="form-select" id="gd_muc_song">
                                <option value="Khó khăn">Khó khăn</option>
                                <option value="Đủ ăn" selected>Đủ ăn</option>
                                <option value="Khá">Khá</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkFamilyCrime"
                                    onchange="toggleSection('divFamilyCrime', this.checked)">
                                <label class="form-check-label fw-bold">Trong gia đình (bố, mẹ, anh, chị em ruột) có ai
                                    đã hoặc đang vi phạm pháp luật không?</label>
                            </div>
                            <div id="divFamilyCrime" class="d-none mt-2">
                                <textarea class="form-control" id="gd_vi_pham_chi_tiet" rows="2"
                                    placeholder="Nếu có là ai? Ghi cụ thể như thế nào? Có bị xử lý hình sự không?"></textarea>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Trong gia đình có ai bị Covid-19 không? Nếu có, ngày nào?</label>
                            <input type="text" class="form-control" id="gd_lich_su_covid"
                                placeholder="Ghi rõ thông tin...">
                        </div>
                    </div>

                    <div class="section-title"><i class="bi bi-people-fill me-2"></i>Chi tiết thân nhân</div>
                    <div class="alert alert-info py-2 small"><i class="bi bi-info-circle me-1"></i>Khai về bố, mẹ, anh,
                        chị, em ruột, vợ, con và 3 người thân thiết nhất vào bảng dưới đây.</div>
                    <div class="table-responsive border rounded bg-white mb-2">
                        <table class="table table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Quan hệ</th>
                                    <th width="20%">Họ tên</th>
                                    <th width="10%">Năm sinh</th>
                                    <th width="20%">Nghề nghiệp</th>
                                    <th width="20%">Quê quán / Nơi ở</th>
                                    <th width="12%">SĐT (Zalo/FB)</th>
                                    <th width="3%"></th>
                                </tr>
                            </thead>
                            <tbody id="familyTableBody"></tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-success dashed-border mb-4"
                        onclick="window.addFamilyRow()"><i class="bi bi-plus-lg"></i> Thêm người thân</button>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning bg-opacity-10 fw-bold">Vợ & Con (Khai chi tiết)</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="fw-bold d-block mb-1">Có vợ chưa?</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="radioVo" value="0"
                                                checked onchange="toggleSection('divVoDetails', false)">
                                            <label class="form-check-label">Chưa</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="radioVo" value="1"
                                                onchange="toggleSection('divVoDetails', true)">
                                            <label class="form-check-label">Có</label>
                                        </div>
                                    </div>

                                    <div id="divVoDetails" class="d-none mb-4 border-bottom pb-2">
                                        <input type="text" class="form-control mb-2" id="vo_ten"
                                            placeholder="Họ tên vợ">
                                        <div class="row g-2 mb-2">
                                            <div class="col-6"><input type="text" class="form-control" id="vo_ns"
                                                    placeholder="Năm sinh"></div>
                                            <div class="col-6"><input type="text" class="form-control" id="vo_sdt"
                                                    placeholder="SĐT"></div>
                                        </div>
                                        <input type="text" class="form-control mb-2" id="vo_nghe"
                                            placeholder="Nghề nghiệp">
                                        <textarea class="form-control" id="vo_diachi" rows="2"
                                            placeholder="Nơi ở hiện nay của vợ"></textarea>
                                    </div>

                                    <div class="mb-2">
                                        <label class="fw-bold d-block mb-1">Có con chưa?</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="radioCon" value="0"
                                                checked onchange="toggleSection('divConDetails', false)">
                                            <label class="form-check-label">Chưa</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="radioCon" value="1"
                                                onchange="toggleSection('divConDetails', true)">
                                            <label class="form-check-label">Có</label>
                                        </div>
                                    </div>
                                    <div id="divConDetails" class="d-none">
                                        <div id="conList"></div>
                                        <button type="button" class="btn btn-sm btn-link p-0"
                                            onclick="window.addChildRow()">+ Thêm con</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-danger">
                                <div class="card-header bg-danger bg-opacity-10 fw-bold">Người yêu</div>
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNY"
                                            onchange="toggleSection('divNYDetails', this.checked)">
                                        <label class="form-check-label fw-bold">Đang có người yêu</label>
                                    </div>
                                    <div id="divNYDetails" class="d-none">
                                        <div id="nyList"></div>
                                        <button type="button" class="btn btn-sm btn-link p-0"
                                            onclick="window.addLoverRow()">+ Thêm người yêu</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: YẾU TỐ NƯỚC NGOÀI -->
                <div class="tab-pane fade" id="tab-foreign" role="tabpanel">
                    <div class="section-title"><i class="bi bi-globe-americas me-2"></i>Quan hệ & Đi nước ngoài</div>

                    <div class="mb-4 border-bottom pb-3">
                        <label class="fw-bold d-block mb-2">Có quan hệ với ai ở nước ngoài không?</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radioForeignRel" value="0" checked
                                onchange="toggleSection('divForeignRel', false)">
                            <label class="form-check-label">Không</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radioForeignRel" value="1"
                                onchange="toggleSection('divForeignRel', true)">
                            <label class="form-check-label">Có</label>
                        </div>

                        <div id="divForeignRel" class="d-none mt-2">
                            <table class="table table-bordered table-sm">
                                <tbody id="foreignRelTable"></tbody>
                            </table>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="window.addForeignRow()">Thêm
                                người (Ai, Quan hệ, Nước nào)</button>
                        </div>
                    </div>

                    <div class="mb-4 border-bottom pb-3">
                        <label class="fw-bold d-block mb-2">Đã từng đi nước ngoài chưa?</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radioTravel" value="0" checked
                                onchange="toggleSection('divTravel', false)">
                            <label class="form-check-label">Chưa đi</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radioTravel" value="1"
                                onchange="toggleSection('divTravel', true)">
                            <label class="form-check-label">Đã đi</label>
                        </div>

                        <div id="divTravel" class="d-none mt-2">
                            <table class="table table-bordered table-sm">
                                <tbody id="travelTable"></tbody>
                            </table>
                            <button type="button" class="btn btn-sm btn-secondary mb-3"
                                onclick="window.addTravelRow()">Thêm lịch sử</button>

                            <label class="form-label text-danger">Có vi phạm gì khi đang ở nước ngoài không?</label>
                            <textarea class="form-control" id="foreign_violation"
                                placeholder="Nếu có ghi rõ..."></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="fw-bold d-block mb-2">Đã có hộ chiếu chưa?</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="radioPassport" value="0" checked
                                    onchange="toggleSection('divPassport', false)">
                                <label class="form-check-label">Chưa</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="radioPassport" value="1"
                                    onchange="toggleSection('divPassport', true)">
                                <label class="form-check-label">Đã có</label>
                            </div>
                            <div id="divPassport" class="d-none mt-2 p-3 bg-light rounded">
                                <label class="small">Dự định đi nước nào?</label>
                                <input type="text" class="form-control mb-2" id="pp_dest">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold d-block mb-2">Bản thân đã hoặc đang làm thủ tục xuất cảnh định
                                cư?</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="radioImmigration" value="0" checked
                                    onchange="toggleSection('divImmigration', false)">
                                <label class="form-check-label">Không</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="radioImmigration" value="1"
                                    onchange="toggleSection('divImmigration', true)">
                                <label class="form-check-label">Có</label>
                            </div>
                            <div id="divImmigration" class="d-none mt-2 p-3 bg-light rounded">
                                <input type="text" class="form-control mb-2" id="im_country" placeholder="Nước định cư">
                                <input type="text" class="form-control" id="im_sponsor" placeholder="Người bảo lãnh">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 5: LỊCH SỬ & TỆ NẠN -->
                <div class="tab-pane fade" id="tab-history" role="tabpanel">
                    <div class="section-title text-danger"><i class="bi bi-shield-exclamation me-2"></i>Dữ Liệu Bảo Mật
                        & Vi Phạm</div>
                    <p class="text-danger small fst-italic mb-3">Lưu ý: Khai báo trung thực các nội dung dưới đây. Thông
                        tin được bảo mật.</p>

                    <div class="card mb-3 sensitive-section">
                        <div class="card-body">
                            <h6 class="fw-bold text-danger">1. Vi phạm tại địa phương (trước nhập ngũ)</h6>
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="vp_local" value="0" checked
                                        onchange="toggleSection('divVPLocal', false)"> <label
                                        class="form-check-label">Không vi phạm</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="vp_local" value="1"
                                        onchange="toggleSection('divVPLocal', true)"> <label
                                        class="form-check-label fw-bold text-danger">Có vi phạm</label>
                                </div>
                            </div>
                            <div id="divVPLocal" class="d-none mt-2 p-3 bg-light rounded">
                                <label class="form-label small fw-bold">Nội dung chi tiết (Thời gian, nội dung, ở
                                    đâu?)</label>
                                <textarea class="form-control mb-2" id="vp_local_content" rows="2"
                                    placeholder="VD: Năm 2020 đánh nhau gây thương tích tại xã X..."></textarea>
                                <label class="form-label small fw-bold">Kết quả giải quyết</label>
                                <textarea class="form-control" id="vp_local_result" rows="2"
                                    placeholder="Đã bị xử phạt hành chính / Đã hòa giải..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 sensitive-section">
                        <div class="card-body">
                            <h6 class="fw-bold text-danger">2. Tham gia đánh bạc / Cá độ</h6>
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="vp_gambling" value="0" checked
                                        onchange="toggleSection('divGambling', false)"> <label
                                        class="form-check-label">Chưa từng</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="vp_gambling" value="1"
                                        onchange="toggleSection('divGambling', true)"> <label
                                        class="form-check-label fw-bold text-danger">Đã từng tham gia</label>
                                </div>
                            </div>
                            <div id="divGambling" class="d-none mt-2 row g-3 p-3 bg-light rounded">
                                <div class="col-md-6">
                                    <label class="small text-muted">Hình thức chơi</label>
                                    <input type="text" class="form-control" id="gb_form"
                                        placeholder="VD: Lô đề, bóng đá, xóc đĩa...">
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted">Chơi với ai?</label>
                                    <input type="text" class="form-control" id="gb_partner"
                                        placeholder="VD: Bạn bè xã hội, người lạ...">
                                </div>
                                <div class="col-md-12">
                                    <label class="small text-muted">Địa điểm / Thời gian</label>
                                    <input type="text" class="form-control" id="gb_place"
                                        placeholder="Chơi ở đâu? Khi nào?">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card sensitive-section">
                        <div class="card-body">
                            <h6 class="fw-bold text-danger">3. Sử dụng Ma túy / Chất gây nghiện</h6>
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="vp_drugs" value="0" checked
                                        onchange="toggleSection('divDrugs', false)"> <label
                                        class="form-check-label">Chưa từng</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="vp_drugs" value="1"
                                        onchange="toggleSection('divDrugs', true)"> <label
                                        class="form-check-label fw-bold text-danger">Đã từng sử dụng</label>
                                </div>
                            </div>
                            <div id="divDrugs" class="d-none mt-2 row g-3 p-3 bg-light rounded">
                                <div class="col-md-4"><label class="small text-muted">Thời gian (từ khi
                                        nào?)</label><input type="text" class="form-control" id="dr_time"></div>
                                <div class="col-md-4"><label class="small text-muted">Loại chất</label><input
                                        type="text" class="form-control" id="dr_type" placeholder="Cỏ, Ke, Đá..."></div>
                                <div class="col-md-4"><label class="small text-muted">Số lần sử dụng</label><input
                                        type="text" class="form-control" id="dr_count"></div>
                                <div class="col-md-6"><label class="small text-muted">Sử dụng với ai?</label><input
                                        type="text" class="form-control" id="dr_partner"></div>
                                <div class="col-md-6"><label class="small text-muted">Đã bị xử lý chưa?</label><input
                                        type="text" class="form-control" id="dr_result" placeholder="Có/Không"></div>
                                <div class="col-md-12">
                                    <label class="small text-muted">Hình thức xử lý (nếu có) & Chi tiết</label>
                                    <textarea class="form-control" id="dr_details" rows="2"
                                        placeholder="Ghi rõ hình thức xử lý..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 6: TÀI CHÍNH & SỨC KHỎE -->
                <div class="tab-pane fade" id="tab-finance" role="tabpanel">
                    <div class="section-title"><i class="bi bi-cash-stack me-2"></i>Tình hình tài chính</div>

                    <!-- DEBT SECTION -->
                    <div class="card mb-4 border-warning">
                        <div class="card-header bg-warning bg-opacity-10 fw-bold text-dark">
                            1. Vay nợ (Cá nhân / Tổ chức / Tín dụng đen...)
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="fw-bold d-block mb-1">Hiện tại có đang vay nợ không?</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radioDebt" value="0" checked
                                        onchange="toggleSection('divDebt', false)">
                                    <label class="form-check-label">Không</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radioDebt" value="1"
                                        onchange="toggleSection('divDebt', true)">
                                    <label class="form-check-label fw-bold">Có</label>
                                </div>
                            </div>

                            <div id="divDebt" class="d-none row g-3 bg-light p-3 rounded">
                                <div class="col-md-6"><label class="small fw-bold">Ai đứng tên vay?</label><input
                                        type="text" class="form-control" id="debt_borrower_name"
                                        placeholder="Bản thân / Vợ / Bố mẹ..."></div>
                                <div class="col-md-6"><label class="small fw-bold">Ai là người trả nợ?</label><input
                                        type="text" class="form-control" id="debt_payer"
                                        placeholder="Người chịu trách nhiệm trả"></div>
                                <div class="col-md-6"><label class="small fw-bold">Vay của ai / Tổ chức
                                        nào?</label><input type="text" class="form-control" id="debt_who"></div>
                                <div class="col-md-3"><label class="small fw-bold">Số tiền (VNĐ)</label><input
                                        type="text" class="form-control" id="debt_amount"></div>
                                <div class="col-md-3"><label class="small fw-bold">Hạn trả</label><input type="text"
                                        class="form-control" id="debt_deadline"></div>
                                <div class="col-md-6"><label class="small fw-bold">Hình thức vay</label><input
                                        type="text" class="form-control" id="debt_type"
                                        placeholder="Tín chấp / Thế chấp / App..."></div>
                                <div class="col-md-6 d-flex align-items-center mt-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="debt_family_knows">
                                        <label class="form-check-label fw-bold">Gia đình đã biết chuyện vay nợ</label>
                                    </div>
                                </div>
                                <div class="col-md-12"><label class="small fw-bold">Mục đích vay & Chi tiết
                                        khác</label><textarea class="form-control" id="debt_purpose" rows="2"
                                        placeholder="Vay để làm gì? ..."></textarea></div>
                            </div>
                        </div>
                    </div>

                    <!-- BUSINESS SECTION -->
                    <div class="card mb-4">
                        <div class="card-header bg-light fw-bold">
                            2. Kinh doanh & Bất động sản
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="d-block mb-1">Có tham gia góp vốn kinh doanh không?</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radioBusiness" value="0" checked
                                        onchange="toggleSection('divBusiness', false)">
                                    <label class="form-check-label">Không</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radioBusiness" value="1"
                                        onchange="toggleSection('divBusiness', true)">
                                    <label class="form-check-label">Có</label>
                                </div>
                            </div>
                            <div id="divBusiness" class="d-none bg-light p-3 rounded">
                                <label class="small fw-bold">Chi tiết đối tác & Địa chỉ kinh doanh</label>
                                <textarea class="form-control" id="bus_details" rows="2"
                                    placeholder="Tên tổ chức/cá nhân, tên công ty, địa chỉ cụ thể..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- HEALTH SECTION -->
                    <div class="section-title"><i class="bi bi-activity me-2"></i>Sức khỏe</div>
                    <div class="card">
                        <div class="card-body">
                            <label class="fw-bold d-block mb-2">Đã từng mắc Covid-19 chưa?</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="radioCovid" value="0" checked
                                    onchange="toggleSection('divCovid', false)">
                                <label class="form-check-label">Không</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="radioCovid" value="1"
                                    onchange="toggleSection('divCovid', true)">
                                <label class="form-check-label">Có</label>
                            </div>
                            <div id="divCovid" class="d-none mt-2">
                                <input type="text" class="form-control" id="covid_time"
                                    placeholder="Thời gian mắc bệnh (Tháng/Năm)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 7: NGUYỆN VỌNG -->
                <div class="tab-pane fade" id="tab-aspirations" role="tabpanel">
                    <div class="section-title"><i class="bi bi-chat-square-quote-fill me-2"></i>Ý kiến, Nguyện vọng &
                        Cam đoan</div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">II. Ý KIẾN VÀ NGUYỆN VỌNG CỦA BẢN THÂN</label>
                        <p class="text-muted small">Đồng chí có ý kiến, đề xuất hoặc hoàn cảnh đặc biệt nào cần đơn vị
                            quan tâm giúp đỡ không?</p>
                        <textarea class="form-control" name="y_kien_nguyen_vong" rows="6"
                            placeholder="Ghi rõ nội dung..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold text-danger">III. CAM ĐOAN</label>
                        <div class="p-3 bg-light border rounded fst-italic">
                            Tôi xin cam đoan những lời khai trên là đúng sự thật, nếu có gì sai trái tôi xin chịu hoàn
                            toàn trách nhiệm trước pháp luật và kỷ luật Quân đội.
                        </div>
                    </div>

                    <div class="row justify-content-end mt-5">
                        <div class="col-md-4 text-center">
                            <div class="fw-bold mb-4">NGƯỜI KHAI</div>
                            <div class="border-bottom border-secondary mb-2" style="height: 40px;"></div>
                            <input type="text"
                                class="form-control text-center border-0 bg-transparent fw-bold text-uppercase"
                                placeholder="Ký, ghi rõ họ tên" disabled>
                            <small class="text-muted">(Ký tên vào bản in)</small>
                        </div>
                    </div>
                </div>

                <!-- TAB 8: CUSTOM FIELDS (NEW) -->
                <div class="tab-pane fade" id="tab-custom" role="tabpanel">
                    <div class="section-title"><i class="bi bi-ui-checks-grid me-2"></i>Thông tin bổ sung</div>
                    <div class="alert alert-light border small"><i class="bi bi-info-circle me-1"></i> Các trường dữ
                        liệu này được yêu cầu thêm bởi đơn vị.</div>
                    <div id="customFieldsContainer" class="row g-3">
                        <!-- Dynamic fields injected here -->
                    </div>

                    <!-- ADMIN CUSTOM FIELD MANAGER (MOVED HERE) -->
                    <div id="admin-custom-field-manager" class="d-none mt-5 border-top pt-4 admin-only-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold text-military m-0"><i class="bi bi-gear-fill me-2"></i>Quản Lý Cấu Hình
                                Trường Tùy Chỉnh (Admin)</h6>
                            <button type="button" class="btn btn-sm btn-military" onclick="openCustomFieldModal('add')">
                                <i class="bi bi-plus-lg me-1"></i>Thêm Trường Dữ Liệu Mới
                            </button>
                        </div>
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-striped table-hover mb-0 align-middle"
                                        style="font-size: 0.9rem;">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Tên Hiển Thị</th>
                                                <th>Key</th>
                                                <th>Kiểu</th>
                                                <th>Đơn Vị</th>
                                                <th class="text-end">Thao Tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customFieldTableBody">
                                            <!-- Loaded via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="d-grid mt-5 pb-5">
                <button type="submit" class="btn btn-military btn-lg py-3 fw-bold" title="Lưu lại hồ sơ hiện tại (Ctrl + S)">
                    <i class="bi bi-save me-2"></i>HOÀN THÀNH & LƯU HỒ SƠ
                </button>
            </div>
        </form>
    </template>

    <script src="renderer.js"></script>
</body>

</html>
